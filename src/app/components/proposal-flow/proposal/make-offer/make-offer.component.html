<app-nav>
  <div left-content>
    <a (click)="goBack()" class="text-decoration-none text-dark">
      <i class="fas fa-arrow-left"></i>
    </a>
  </div>
  <div central-content>
    <a routerLink="/" class="logo">
      <img
        src="../../../assets/logo-rosa.webp"
        class="img-fluid"
        style="width: 4em"
        alt="error"
      />
    </a>
  </div>
  <div right-content>
    <!-- Botão de login -->
    <!-- <a routerLink="/login" class="login-button">
      <i class="fas fa-bars"></i>
      <i class="fas fa-user fs-3"></i>
    </a> -->
  </div>
</app-nav>

<section class="min-h-screen p-3 p-md-4" *ngIf="!isLoading">
  <div class="max-w-4xl mx-auto w-full transition-smooth">
    <!-- Loading state -->
    <!-- <div class="p-8">
      <div class="animate-pulse space-y-6">
        <div class="h-8 bg-gray-200 rounded w-3/4"></div>
        <div class="h-4 bg-gray-200 rounded w-full"></div>
        <div class="h-4 bg-gray-200 rounded w-5/6"></div>
        <div class="h-12 bg-gray-200 rounded mt-8"></div>
        <div class="h-12 bg-gray-200 rounded"></div>
      </div>
    </div> -->

    <!-- Content state -->
    <div class="p-2 pt-4 pb-4 md:p-10">
      <!-- Header -->
      <div class="text-center mb-8">
        <div class="flex flex-column items-center justify-center gap-3 mb-2">
          <h2 class="text-2xl md:text-3xl font-bold">Faça sua oferta</h2>
        </div>
        <div class="space-y-2">
          <h3 class="text-lg md:text-xl font-semibold">
            Defina um preço para esse serviço
          </h3>
          <!-- <p class="text-sm md:text-base">
            Dica: O preço para montar custa entre 15% e 30% do valor do móvel
          </p> -->
          <i class="fas fa-credit-card text-pink-600 text-2xl"></i>
        </div>
      </div>

      <!-- Card de Estimativa -->
      <div
        class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-6 mb-4 text-white shadow-lg"
        style="background-color: var(--primary)"
      >
        <div class="flex items-center gap-4">
          <div
            class="bg-white bg-opacity-10 w-12 h-12 rounded-full flex items-center justify-center"
          >
            <i class="fas fa-tag text-xl"></i>
          </div>
          <div>
            <h4 class="font-bold text-white">Estimativa de Preço</h4>
            <p class="opacity-90">
              {{
                priceEstimation?.description ||
                  "Montagem e instalação profissional"
              }}
            </p>
          </div>
        </div>

        <!-- Preço Médio -->
        <div class="text-center mb-4">
          <span class="text-purple-200 text-sm block mb-1"
            >Preço Médio Sugerido</span
          >
          <div class="text-4xl font-bold">
            R$ {{ priceEstimation?.basePrice || "0,00" }}
          </div>
        </div>

        <!-- Range de Preços -->
        <!-- <div class="flex items-center justify-center gap-6 mb-4">
          <div class="text-center">
            <span class="text-purple-200 text-xs block">Mínimo</span>
            <span class="font-semibold"
              >R$ {{ priceEstimation?.minPrice || "0,00" }}</span
            >
          </div>
          <div class="h-8 w-px bg-purple-300"></div>
          <div class="text-center">
            <span class="text-purple-200 text-xs block">Máximo</span>
            <span class="font-semibold"
              >R$ {{ priceEstimation?.maxPrice || "0,00" }}</span
            >
          </div>
        </div> -->

        <!-- Fatores Considerados -->
        <div
          *ngIf="priceEstimation?.factors && priceEstimation.factors.length > 0"
          class="bg-opacity-10 rounded-xl p-1"
        >
          <h5 class="font-semibold text-sm mb-2 flex items-center gap-2">
            <i class="fas fa-check-circle"></i>
            Itens considerados
          </h5>
          <div class="flex flex-wrap gap-2">
            <span
              *ngFor="let factor of priceEstimation.factors"
              class="px-2 py-1 rounded-full text-xs"
            >
              {{ factor }}
            </span>
          </div>
        </div>

        <!-- Nota Informativa -->
        <!-- <div class="flex items-start gap-2 text-xs text-purple-100 opacity-80">
          <i class="fas fa-info-circle mt-0.5"></i>
          <p>
            Esta é uma estimativa baseada em dados de mercado. O preço final
            pode variar após avaliação técnica.
          </p>
        </div> -->
      </div>

      <!-- Dica sobre o valor -->
      <div class="mt-2 p-3 mb-5 bg-blue-50 rounded-lg border border-blue-200">
        <div class="flex items-start gap-2">
          <i class="fas fa-lightbulb text-blue-500 mt-0.5"></i>
          <div>
            <p class="text-sm text-blue-800 font-medium">
              Você pode ajustar o valor
            </p>
            <p class="text-xs text-blue-600">
              Sugerimos R$ {{ priceEstimation?.basePrice || "0,00" }}, mas você
              pode oferecer qualquer valor
            </p>
          </div>
        </div>
      </div>

      <!-- Formulário de Oferta -->
      <div class="space-y-6 flex flex-column">
        <!-- Price input com informações claras -->
        <div class="w-full">
          <div class="flex justify-between items-center mb-2">
            <label for="price" class="block text-sm font-medium text-gray-700">
              Valor da sua oferta
            </label>
            <span class="text-xs text-gray-500">
              Mínimo: R$ 50
            </span>
          </div>

          <div class="relative rounded-md shadow-sm">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <span class="text-gray-500 sm:text-sm">R$</span>
            </div>
            <input
              type="text"
              id="price"
              [(ngModel)]="price"
              name="price"
              [value]="priceEstimation?.basePrice || ''"
              class="price-input block w-full pl-10 pr-12 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all duration-200"
              currencyMask
              inputmode="numeric"
              [options]="currencyOptions"
              placeholder="50,00"
              (blur)="validateMinimumValue()"
              [class.is-invalid]="showMinError"
              [min]="priceEstimation?.minPrice || 0"
              step="0.01"
            />
            <div
              class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"
            >
              <i class="fas fa-edit text-gray-400"></i>
            </div>
          </div>
        </div>

        <!-- Calendar Component -->
        <app-calendar
          [hasTime]="true"
          (dateSelectedChange)="onDateSelected($event)"
          (timeSelectedChange)="onTimeSelected($event)"
        >
        </app-calendar>

        <!-- Info text -->
        <!-- <div
          class="text-center p-4 bg-gray-50 rounded-lg border border-gray-200"
        >
          <p class="text-gray-600 text-sm">
            <i class="fas fa-handshake text-pink-500 mr-1"></i>
            Este não é o valor final. Você pode negociar diretamente com o
            prestador após a contratação.
          </p>
        </div> -->
      </div>

      <!-- Buttons -->
      <div class="mt-8 flex flex-column gap-2">
        <button
          (click)="payAndCreateCard()"
          class="col-12 btn btn-primary"
          [disabled]="dateTimeSelected === '' || price === ''"
        >
          Avançar
          <i class="fas fa-paper-plane"></i>
        </button>
        <button (click)="goBack()" class="col-12 btn btn-outline-primary">
          Voltar
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Modal  -->
<app-custom-modal #meuModal (click)="closeAndGoToLogin()"></app-custom-modal>

<!-- ----------------- LOADER MAKE-OFFER ------------------ -->
<div
  *ngIf="isLoading"
  class="flex flex-col items-center justify-center min-h-screen space-y-8"
>
  <div
    class="text-5xl font-bold animate-pulse"
    style="color: #f80e6e; font-family: 'Roboto', sans-serif"
  >
    Tudü
  </div>
  <div
    class="text-center text-xl px-6 leading-relaxed"
    style="color: var(--secondary)"
  >
    Estamos finalizando a criação do seu pedido...
  </div>
  <div
    class="w-20 h-20 border-4 border-[#f80e6e] border-t-transparent rounded-full animate-spin"
  ></div>
</div>
