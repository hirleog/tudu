<app-nav>
  <div left-content>
    <i class="fas fa-arrow-left" (click)="goBack()"></i>
  </div>
  <div central-content>
    <a routerLink="/" class="logo">
      <img
        src="../../../assets/logo-rosa.webp"
        class="img-fluid"
        style="width: 4em"
        alt="Tudu Logo"
      />
    </a>
  </div>
  <div right-content></div>
</app-nav>

<section id="password-reset" class="d-flex justify-content-center mt-5">
  <div class="row container d-flex justify-content-center">
    <div class="max-w-4xl mx-auto lg:px-8">
      <div class="card shadow">
        <div class="card-header text-center bg-white">
          <h4 class="mb-0">Redefinir Senha</h4>
        </div>

        <div class="card-body p-4">
          <!-- Progress Steps -->
          <div class="progress-steps mb-4">
            <div
              class="step"
              [class.active]="currentStep >= 1"
              [class.completed]="currentStep > 1"
            >
              <span class="step-number">1</span>
              <span class="step-label">Email</span>
            </div>
            <div
              class="step"
              [class.active]="currentStep >= 2"
              [class.completed]="currentStep > 2"
            >
              <span class="step-number">2</span>
              <span class="step-label">Código</span>
            </div>
            <div class="step" [class.active]="currentStep >= 3">
              <span class="step-number">3</span>
              <span class="step-label">Nova Senha</span>
            </div>
          </div>

          <!-- Error Message -->
          <div
            *ngIf="errorMessage"
            class="alert alert-danger alert-dismissible fade show"
            role="alert"
          >
            {{ errorMessage }}
            <button
              type="button"
              class="btn-close"
              (click)="errorMessage = ''"
            ></button>
          </div>

          <!-- Success Message -->
          <div
            *ngIf="successMessage"
            class="alert alert-success alert-dismissible fade show"
            role="alert"
          >
            {{ successMessage }}
            <button
              type="button"
              class="btn-close"
              (click)="successMessage = ''"
            ></button>
          </div>

          <!-- Step 1: Email -->
          <div *ngIf="currentStep === 1">
            <p class="text-muted mb-4">
              Informe seu email para receber um código de verificação
            </p>

            <form [formGroup]="resetForm">
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  formControlName="email"
                  placeholder="seu@email.com"
                  [class.is-invalid]="
                    resetForm.get('email')?.invalid &&
                    resetForm.get('email')?.touched
                  "
                />
                <div
                  *ngIf="
                    resetForm.get('email')?.invalid &&
                    resetForm.get('email')?.touched
                  "
                  class="invalid-feedback"
                >
                  Por favor, informe um email válido
                </div>
              </div>

              <button
                type="button"
                class="btn btn-primary w-100"
                (click)="requestResetCode()"
                [disabled]="resetForm.get('email')?.invalid || isLoading"
              >
                <span
                  *ngIf="isLoading"
                  class="spinner-border spinner-border-sm me-2"
                ></span>
                Enviar Código
              </button>
            </form>
          </div>

          <!-- Step 2: Código -->
          <div *ngIf="currentStep === 2">
            <p class="text-muted mb-4">
              Enviamos um código de 6 dígitos para
              <strong>{{ resetForm.get("email")?.value }}</strong>
            </p>

            <form [formGroup]="resetForm">
              <div class="mb-3">
                <label for="code" class="form-label"
                  >Código de Verificação</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="code"
                  formControlName="code"
                  placeholder="000000"
                  maxlength="6"
                  [class.is-invalid]="
                    resetForm.get('code')?.invalid &&
                    resetForm.get('code')?.touched
                  "
                />
                <div
                  *ngIf="
                    resetForm.get('code')?.invalid &&
                    resetForm.get('code')?.touched
                  "
                  class="invalid-feedback"
                >
                  Por favor, informe o código de 6 dígitos
                </div>

                <div class="mt-2 text-center">
                  <small class="text-muted">
                    Não recebeu?
                    <a
                      href="javascript:void(0)"
                      (click)="resendCode()"
                      [class.text-muted]="countdown > 0"
                      [class.text-primary]="countdown <= 0"
                    >
                      Reenviar código
                      {{ countdown > 0 ? "(" + countdown + "s)" : "" }}
                    </a>
                  </small>
                </div>
              </div>

              <button
                type="button"
                class="btn btn-primary w-100"
                (click)="verifyCode()"
                [disabled]="resetForm.get('code')?.invalid || isLoading"
              >
                <span
                  *ngIf="isLoading"
                  class="spinner-border spinner-border-sm me-2"
                ></span>
                Verificar Código
              </button>
            </form>
          </div>

          <!-- Step 3: Nova Senha -->
          <div *ngIf="currentStep === 3">
            <p class="text-muted mb-4">Crie uma nova senha para sua conta</p>

            <form [formGroup]="resetForm">
              <div class="mb-3">
                <label for="newPassword" class="form-label">Nova Senha</label>
                <input
                  type="password"
                  class="form-control"
                  id="newPassword"
                  formControlName="newPassword"
                  placeholder="Mínimo 6 caracteres"
                  [class.is-invalid]="
                    resetForm.get('newPassword')?.invalid &&
                    resetForm.get('newPassword')?.touched
                  "
                />
                <div
                  *ngIf="
                    resetForm.get('newPassword')?.invalid &&
                    resetForm.get('newPassword')?.touched
                  "
                  class="invalid-feedback"
                >
                  A senha deve ter pelo menos 6 caracteres
                </div>
              </div>

              <div class="mb-3">
                <label for="confirmPassword" class="form-label"
                  >Confirmar Senha</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="confirmPassword"
                  formControlName="confirmPassword"
                  placeholder="Digite novamente a senha"
                  [class.is-invalid]="
                    (resetForm.get('confirmPassword')?.invalid ||
                      resetForm.hasError('mismatch')) &&
                    resetForm.get('confirmPassword')?.touched
                  "
                />
                <div
                  *ngIf="
                    resetForm.hasError('mismatch') &&
                    resetForm.get('confirmPassword')?.touched
                  "
                  class="invalid-feedback"
                >
                  As senhas não coincidem
                </div>
              </div>

              <button
                type="button"
                class="btn btn-primary w-100"
                (click)="resetPassword()"
                [disabled]="resetForm.invalid || isLoading"
              >
                <span
                  *ngIf="isLoading"
                  class="spinner-border spinner-border-sm me-2"
                ></span>
                Redefinir Senha
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- MODAL -->
<app-custom-modal
  #meuModal
  (click)="customModal.closeModal()"
></app-custom-modal>
