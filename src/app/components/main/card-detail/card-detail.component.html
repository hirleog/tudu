<lib-nav>
  <div left-content>
    <a (click)="back()" class="text-decoration-none text-dark">
      <i
        class="fas fa-arrow-left me-2"
        style="font-size: 1.5em; color: var(--light)"
      ></i>
    </a>
  </div>
  <div central-content>
    <h3 class="title-page m-0" style="color: var(--light)">Detalhes</h3>
  </div>
  <div right-content>
    <i
      class="fas fa-question-circle"
      style="font-size: 1.5em; color: var(--light)"
      title="Clique para mais informações"
      (click)="openModal()"
    ></i>
  </div>
</lib-nav>

<section class="min-h-screen bg-white pb-24">
  <!-- padding bottom para o botão fixo -->
  <div id="card-detail" class="max-w-4xl mx-auto" *ngFor="let card of cards">
    <!-- Galeria de Imagens (Estilo Airbnb) -->
    <div *ngIf="card.imagens && card.imagens.length > 0" class="relative">
      <div class="relative w-full aspect-[4/3] bg-gray-100 overflow-hidden">
        <img
          [src]="card.imagens[card.currentImageIndex || 0]"
          alt="Imagem do Serviço"
          class="w-full h-full object-cover"
          onerror="this.onerror=null;this.src='https://placehold.co/600x400/E0E0E0/616161?text=Imagem+indisponível';"
        />

        <!-- Navegação de Imagens -->
        <button
          *ngIf="card.imagens.length > 1"
          (click)="navigateImages(card, -1)"
          class="absolute left-3 top-1/2 -translate-y-1/2 w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-50 transition-colors"
        >
          <i class="fas fa-chevron-left text-gray-600"></i>
        </button>
        <button
          *ngIf="card.imagens.length > 1"
          (click)="navigateImages(card, 1)"
          class="absolute right-3 top-1/2 -translate-y-1/2 w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-50 transition-colors"
        >
          <i class="fas fa-chevron-right text-gray-600"></i>
        </button>

        <!-- Indicador de Imagens -->
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2">
          <div
            *ngFor="let img of card.imagens; let i = index"
            class="w-2 h-2 rounded-full transition-all duration-300"
            [class]="
              i === (card.currentImageIndex || 0)
                ? 'bg-white'
                : 'bg-white bg-opacity-50'
            "
          ></div>
        </div>
      </div>

      <!-- Miniaturas Scroll Horizontal -->
      <div
        *ngIf="card.imagens.length > 1"
        class="flex overflow-x-auto space-x-2 px-4 py-3 border-b border-gray-200 bg-white"
      >
        <img
          *ngFor="let imagem of card.imagens; let imgIndex = index"
          [src]="imagem"
          alt="Miniatura"
          class="w-16 h-16 object-cover rounded-lg cursor-pointer border-2 transition-all duration-200 flex-shrink-0"
          [ngClass]="{
            'border-pink-500 shadow-md':
              imgIndex === (card.currentImageIndex || 0),
            'border-transparent hover:border-gray-300':
              imgIndex !== (card.currentImageIndex || 0)
          }"
          (click)="selectImage(card, imgIndex)"
          onerror="this.onerror=null;this.src='https://placehold.co/64x64/E0E0E0/616161?text=Mini';"
        />
      </div>
    </div>

    <!-- Header do Serviço (Estilo Airbnb) -->
    <div class="px-4 py-6 border-b border-gray-200">
      <div class="flex items-start justify-between mb-3">
        <h1 class="text-2xl font-semibold text-gray-900">
          {{ card.categoria }}
        </h1>
        <i
          [class]="card.icon"
          class="text-2xl"
          style="color: var(--primary)"
        ></i>
      </div>

      <p class="text-gray-600 mb-4">{{ card.subcategoria }}</p>

      <!-- Badges de Status -->
      <div class="flex items-center gap-3">
        <span
          class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
          [ngClass]="{
            'bg-green-100 text-green-800': card.status_pedido === 'publicado',
            'bg-blue-100 text-blue-800': card.status_pedido === 'andamento',
            'bg-gray-100 text-gray-800': card.status_pedido === 'finalizado',
            'bg-red-100 text-red-800': card.status_pedido === 'cancelado',
            'bg-yellow-100 text-yellow-800': card.status_pedido === 'pendente'
          }"
        >
          {{ getStatusText(card.status_pedido) }}
        </span>
        <span class="text-gray-400">•</span>
        <span class="text-gray-500 text-sm">Pedido #{{ card.id_pedido }}</span>
      </div>
    </div>

    <!-- Informações do Serviço (Estilo Airbnb) -->
    <div class="px-4 py-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Sobre o serviço</h2>

      <div class="space-y-4">
        <!-- Descrição -->
        <div class="flex items-start">
          <i
            class="fas fa-file-alt text-gray-400 mt-1 mr-4 w-5 text-center"
          ></i>
          <div class="flex-1">
            <p class="text-gray-900 font-medium mb-1">Descrição</p>
            <p class="text-gray-600">{{ card.serviceDescription }}</p>
          </div>
        </div>

        <!-- Localização -->
        <div class="flex items-start">
          <i
            class="fas fa-map-marker-alt text-gray-400 mt-1 mr-4 w-5 text-center"
          ></i>
          <div class="">
            <p class="text-gray-900 font-medium mb-1">Localização</p>
            <p class="text-gray-600">
              {{ card.address.street }}, {{ card.address.number }}<br />
              {{ card.address.neighborhood }}<br />
              {{ card.address.city }} - {{ card.address.state }}
            </p>
          </div>
        </div>

        <!-- Horário -->
        <div class="flex items-start">
          <i class="fas fa-clock text-gray-400 mt-1 mr-4 w-5 text-center"></i>
          <div class="flex-1">
            <p class="text-gray-900 font-medium mb-1">Horário Preferencial</p>
            <p class="text-gray-600">
              {{ formatDateTime(card.horario_preferencial) }}
            </p>
          </div>
        </div>

        <!-- Valor -->
        <div class="flex items-start">
          <i
            class="fas fa-dollar-sign text-gray-400 mt-1 mr-4 w-5 text-center"
          ></i>
          <div class="flex-1">
            <p class="text-gray-900 font-medium mb-1">Valor</p>
            <p class="text-2xl font-bold text-gray-900">R$ {{ card.valor }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Detalhes do Pedido -->
    <div class="px-4 py-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">
        Detalhes do pedido
      </h2>

      <div class="grid grid-cols-2 gap-6">
        <div>
          <p class="text-gray-500 text-sm mb-1">Solicitado em</p>
          <p class="text-gray-900 font-medium">
            {{ card.createdAt | date : "dd/MM/yyyy" }}
          </p>
          <p class="text-gray-500 text-xs">
            {{ card.createdAt | date : "HH:mm" }}
          </p>
        </div>

        <div *ngIf="card.data_finalizacao">
          <p class="text-gray-500 text-sm mb-1">Concluído em</p>
          <p class="text-gray-900 font-medium">
            {{ card.data_finalizacao | date : "dd/MM/yyyy" }}
          </p>
          <p class="text-gray-500 text-xs">
            {{ card.data_finalizacao | date : "HH:mm" }}
          </p>
        </div>
      </div>
    </div>

    <!-- Candidaturas (se houver) -->
    <div
      *ngIf="card.candidaturas && card.candidaturas.length > 0"
      class="px-4 py-6 border-b border-gray-200"
    >
      <div class="flex items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-900">
          {{ isProfessionalIndicator ? "Meu Lance" : "Propostas Recebidas" }}
        </h2>
        <span
          class="bg-pink-100 text-pink-800 text-sm font-medium px-2.5 py-0.5 rounded-full ml-2"
        >
          {{ card.candidaturas.length }}
        </span>
      </div>

      <div class="space-y-3">
        <div
          *ngFor="let candidatura of card.candidaturas"
          class="p-4 border border-gray-200 rounded-xl hover:border-gray-300 transition-colors bg-white"
        >
          <div class="flex justify-between items-start mb-2">
            <div>
              <p class="text-lg font-bold text-gray-900">
                R$ {{ candidatura.valor_negociado }}
              </p>
              <p class="text-gray-600 text-sm">
                {{ candidatura.horario_negociado }}
              </p>
            </div>
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
              [ngClass]="{
                'bg-blue-100 text-blue-800':
                  candidatura.status === 'negociacao',
                'bg-green-100 text-green-800': candidatura.status === 'aceito',
                'bg-red-100 text-red-800': candidatura.status === 'recusado',
                'bg-gray-100 text-gray-800': candidatura.status === 'cancelado'
              }"
            >
              {{
                getCandidaturaStatusText(
                  candidatura.status ? candidatura.status : ""
                )
              }}
            </span>
          </div>
          <p class="text-gray-500 text-xs">
            Candidatado em:
            <!-- {{ candidatura.data_candidatura | date : "dd/MM/yyyy 'às' HH:mm" }} -->
          </p>
        </div>
      </div>
    </div>

    <!-- Seção de Ajuda (Mantida como estava) -->
    <div
      class="options mb-6 rounded-xl space-y-4 p-4"
      *ngIf="!isProfessionalIndicator && flow !== 'publicado'"
    >
      <h4 class="text-lg font-semibold text-gray-800 mb-4">
        Opções que podem te ajudar
      </h4>

      <!-- Accordion Container -->
      <div class="space-y-1">
        <!-- Problemas com o Pedido -->
        <div class="border rounded-lg overflow-hidden">
          <button
            (click)="toggleAccordion('pedido')"
            class="w-full flex justify-between items-center p-4 hover:bg-gray-50 transition-colors"
          >
            <span class="font-medium text-gray-800"
              >Problemas com o pedido</span
            >
            <i
              [class]="
                activeAccordion === 'pedido'
                  ? 'fas fa-chevron-up'
                  : 'fas fa-chevron-down'
              "
              class="text-gray-500"
            ></i>
          </button>
          <div
            [class]="activeAccordion === 'pedido' ? 'max-h-96' : 'max-h-0'"
            class="overflow-hidden transition-all duration-300"
          >
            <div class="p-4 bg-gray-50 space-y-2">
              <button
                (click)="handleOption('Pedido incompleto', card)"
                class="w-full text-left p-2 rounded"
              >
                Pedido incompleto
              </button>
              <button
                (click)="
                  handleOption('Problemas com a qualidade do pedido', card)
                "
                class="w-full text-left p-2 rounded"
              >
                Problemas com a qualidade do pedido
              </button>
              <button
                (click)="handleOption('Reportar pedido não realizado', card)"
                class="w-full text-left p-2 rounded"
              >
                Reportar pedido não realizado
              </button>
              <button
                (click)="handleOption('Alterar avaliação do pedido', card)"
                class="w-full text-left p-2 rounded"
              >
                Alterar avaliação do pedido
              </button>
            </div>
          </div>
        </div>

        <!-- Problemas com o Pagamento -->
        <div class="border rounded-lg overflow-hidden">
          <button
            (click)="toggleAccordion('pagamento')"
            class="w-full flex justify-between items-center p-4 hover:bg-gray-50 transition-colors"
          >
            <span class="font-medium text-gray-800"
              >Problemas com o pagamento</span
            >
            <i
              [class]="
                activeAccordion === 'pagamento'
                  ? 'fas fa-chevron-up'
                  : 'fas fa-chevron-down'
              "
              class="text-gray-500"
            ></i>
          </button>
          <div
            [class]="activeAccordion === 'pagamento' ? 'max-h-96' : 'max-h-0'"
            class="overflow-hidden transition-all duration-300"
          >
            <div class="p-4 bg-gray-50 space-y-2">
              <button
                (click)="
                  handleOption('Valor foi cobrado mais de uma vez', card)
                "
                class="w-full text-left p-2 rounded"
              >
                Valor foi cobrado mais de uma vez
              </button>
              <button
                (click)="handleOption('Valor foi cobrado errado', card)"
                class="w-full text-left p-2 rounded"
              >
                Valor foi cobrado errado
              </button>
              <button
                (click)="handleOption('Solicitar recibo', card)"
                class="w-full text-left p-2 rounded"
              >
                Solicitar recibo
              </button>
            </div>
          </div>
        </div>

        <!-- Casos Críticos -->
        <div class="border rounded-lg overflow-hidden">
          <button
            (click)="toggleAccordion('criticos')"
            class="w-full flex justify-between items-center p-4 hover:bg-gray-50 transition-colors"
          >
            <span class="font-medium text-gray-800">Casos críticos</span>
            <i
              [class]="
                activeAccordion === 'criticos'
                  ? 'fas fa-chevron-up'
                  : 'fas fa-chevron-down'
              "
              class="text-gray-500"
            ></i>
          </button>
          <div
            [class]="activeAccordion === 'criticos' ? 'max-h-96' : 'max-h-0'"
            class="overflow-hidden transition-all duration-300"
          >
            <div class="p-4 bg-gray-50 space-y-4">
              <!-- Relatar Má Conduta -->
              <div>
                <h5 class="font-medium text-gray-700 mb-2">
                  Relatar má conduta
                </h5>
                <div class="space-y-2 pl-3">
                  <button
                    (click)="
                      handleOption('Prestador solicitou dados pessoais', card)
                    "
                    class="w-full text-left p-2 rounded"
                  >
                    Prestador solicitou dados pessoais
                  </button>
                  <button
                    (click)="
                      handleOption('Prestador era diferente da foto', card)
                    "
                    class="w-full text-left p-2 rounded"
                  >
                    Prestador era diferente da foto
                  </button>
                </div>
              </div>

              <!-- Reportar Incidente Grave -->
              <div>
                <h5 class="font-medium text-gray-700 mb-2">
                  Reportar um incidente grave
                </h5>
                <div class="space-y-2 pl-3">
                  <button
                    (click)="handleOption('Sofri uma agressão verbal', card)"
                    class="w-full text-left p-2 rounded"
                  >
                    Sofri uma agressão verbal
                  </button>
                  <button
                    (click)="handleOption('Sofri uma agressão física', card)"
                    class="w-full text-left p-2 rounded"
                  >
                    Sofri uma agressão física
                  </button>
                  <button
                    (click)="handleOption('Cobrança adicional via PIX', card)"
                    class="w-full text-left p-2 rounded"
                  >
                    Cobrança adicional via PIX
                  </button>
                  <button
                    (click)="
                      handleOption('Cobrança adicional via maquininhaa', card)
                    "
                    class="w-full text-left p-2 rounded"
                  >
                    Cobrança adicional via maquininha
                  </button>
                  <button
                    (click)="
                      handleOption('O prestador sofreu um acidente', card)
                    "
                    class="w-full text-left p-2 rounded"
                  >
                    O prestador sofreu um acidente
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Botão de Negociação (mantido como estava) -->
    <app-mobile-negotiation-bar
      class="py-3 px-4"
      *ngIf="hideMobileButtons(card)"
      [startDateTime]="card.horario_preferencial"
      [value]="card.valor"
      [negotiateButtonText]="'Negociar'"
      [advanceButtonText]="'Avançar'"
      [hideAdvanceBtn]="flow === 'recusado' ? true : false"
      (onNegotiate)="handleNegotiate($event)"
      (onAdvance)="handleAdvance($event)"
    >
    </app-mobile-negotiation-bar>
    <div
      *ngIf="hideCancelBtn(card.status_pedido)"
      class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg z-40"
    >
      <div class="max-w-4xl mx-auto">
        <button
          class="w-full py-3 px-4 border border-red-500 text-red-500 rounded-xl font-medium hover:bg-red-50 transition-colors"
          (click)="handleOption('cancelar', cards[0])"
        >
          {{
            isProfessionalIndicator ? "Cancelar candidatura" : "Cancelar pedido"
          }}
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Botão Fixo no Bottom (mantido) -->

<!-- MODAIS (mantidos exatamente como estavam) -->
<app-custom-modal
  #modalCandidatar
  [actionButtonText]="'Candidatar'"
  [isLoadingBtn]="isLoadingBtn"
  (modalAction)="handleModalAction(cards[0])"
></app-custom-modal>

<app-custom-modal
  #modalNegociar
  [actionButtonText]="'Negociar'"
  [isLoadingBtn]="isLoadingBtn"
  (modalAction)="handleModalAction(cards[0])"
>
  <div optional-content class="space-y-4">
    <div class="bg-gray-50 p-4 rounded-3xl border border-gray-100">
      <label class="block text-xs font-bold text-gray-400 uppercase ml-1 mb-2"
        >Sua proposta de valor</label
      >
      <div class="relative">
        <div
          class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
        >
          <span class="text-gray-900 font-bold text-lg">R$</span>
        </div>
        <input
          type="text"
          class="block w-full pl-12 pr-4 py-4 bg-white border-none rounded-2xl text-lg font-bold shadow-sm focus:ring-2 focus:ring-gray-900 transition-all"
          [(ngModel)]="priceNegotiated"
          currencyMask
          [options]="currencyOptions"
          inputmode="numeric"
        />
      </div>
      <p class="mt-2 text-[11px] text-gray-500 ml-1">
        Valor original:
        {{ (cards.length > 0 ? cards[0].valor : 0) | currency : "BRL" }}
      </p>
    </div>

    <div class="bg-gray-50 p-4 rounded-3xl border border-gray-100">
      <label class="block text-xs font-bold text-gray-400 uppercase ml-1 mb-2"
        >Nova data e horário</label
      >
      <div class="relative" (click)="calendarActive = !calendarActive">
        <div
          class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
        >
          <i class="far fa-calendar-alt text-gray-900 text-lg"></i>
        </div>
        <input
          readonly
          type="text"
          class="block w-full pl-12 pr-4 py-4 bg-white border-none rounded-2xl text-sm font-semibold shadow-sm cursor-pointer"
          [value]="
            dateTimeSelected ||
            (cards.length > 0
              ? (cards[0].horario_preferencial | date : 'dd/MM/yyyy - HH:mm')
              : '')
          "
          placeholder="Selecione uma data"
        />
      </div>

      <div
        *ngIf="calendarActive"
        class="mt-4 overflow-hidden rounded-2xl border border-gray-200 shadow-inner bg-white animate-fade-in"
      >
        <app-calendar
          [hasTime]="true"
          [showWeekView]="false"
          [initialDateTime]="
            cards.length > 0 ? cards[0].horario_preferencial : null
          "
          [hideCalendarInput]="true"
          [calendarActive]="true"
          (dateSelectedChange)="onDateSelected($event)"
          (timeSelectedChange)="onTimeSelected($event)"
          (closeCalendar)="calendarActive = false"
        ></app-calendar>
      </div>
    </div>
  </div>
</app-custom-modal>

<app-custom-modal
  #modalConfirmacao
  [messageTitle]="'Proposta enviada com sucesso!'"
  [actionButtonText]="'Ver pedidos'"
  [showBtn]="modalConfirmIndicator"
  (modalClosed)="(true)"
  (modalAction)="goToHomeSeeProposal()"
></app-custom-modal>

<!-- modal -->
<div [ngClass]="{ 'modal-backdrop': isModalVisible }"></div>

<div
  class="modal fade"
  id="exampleModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
  *ngIf="isModalVisible"
  [ngClass]="{ show: isModalVisible }"
  style="display: block"
>
  <div class="modal-dialog modal-dialog-bottom">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Escolha uma opção</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Close"
          (click)="closeModal()"
        ></button>
      </div>
      <div class="modal-body d-flex flex-column gap-2">
        <button
          class="btn-ui btn-secondary w-100 mb-2"
          (click)="editarAnuncio()"
        >
          <i class="fas fa-edit"></i> Editar anúncio
        </button>
        <!-- <button class="btn-ui btn-danger w-100 mb-2" (click)="cancelarPedido()">
          <i class="fas fa-times-circle"></i> Cancelar pedido
        </button> -->
        <button class="btn-ui btn-info w-100" (click)="falarComAtendente()">
          <i class="fas fa-comment-dots"></i> Falar com atendente
        </button>
      </div>
    </div>
  </div>
</div>
